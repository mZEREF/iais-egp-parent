<?xml version="1.0" encoding="UTF-8"?>
<sqls catalog="systemAdmin">
    <sql key = "masterCodeQuery" remarks = "query MasterCode sql">
        <![CDATA[
            SELECT master_code_id,
                   master_code_key,
                   (SELECT category_description FROM cm_master_code_category where code_category = mc.code_category) as code_category,
                   code_value,
                   code_description,
                   remarks,
                   status,
                   effective_from,
                   effective_to,
                   version
            FROM CM_MASTER_CODE as mc
            WHERE mc.STATUS != 'CMSTAT002'
            <#if id??> AND CHARINDEX(:id, mc.master_code_id) >0</#if>
            <#if codeCategory??> AND mc.code_category = :codeCategory</#if>
            <#if codeDescription??> AND mc.code_description = :codeDescription</#if>
            <#if esd??> AND mc.effective_from > :esd</#if>
            <#if eed??> AND mc.effective_to < :eed</#if>
            <#if codeStatus??> AND mc.status = :codeStatus</#if>
        ]]>
    </sql>

    <sql key = "IntranetUserQuery" remarks = "query IntranetUser sql">
        <![CDATA[
            SELECT
            id,
            USER_ID,
			DISPLAY_NAME,
			EMAIL_ADDR,
			STATUS
			FROM user_account as iu
            WHERE 1=1
            <#if id??> AND CHARINDEX(:id, iu.id) >0</#if>
            <#if userId??> AND iu.USER_ID = :userId</#if>
            <#if displayName??> AND iu.DISPLAY_NAME = :displayName</#if>
            <#if email??> AND iu.EMAIL_ADDR = :email</#if>
            <#if status??> AND iu.STATUS > :status</#if>
        ]]>
    </sql>

    <sql key = "findMasterCodeByDescription" remarks = "Find MasterCode By Description">
        <![CDATA[
            SELECT
                master_code_id,
                master_code_key,
                (SELECT category_description FROM cm_master_code_category where code_category = t1.code_category) as code_category,
                code_value,
                code_description,
                remarks,
                status,
                effective_from,
                effective_to,
                version,
            FROM
                cm_master_code as t1
            WHERE code_category =
                (
                    SELECT
                        code_category
                     FROM
                        cm_master_code_category AS cmcc
                     WHERE 1=1
                        <#if categoryDescription??> AND cmcc.catequeryMessagegory_description = :categoryDescription</#if>
                )
            <#if master_code_id??> AND CHARINDEX(:master_code_id, mc.master_code_id) >0</#if>
        ]]>
    </sql>

    <sql key = "queryMessage" remarks = "query message sql">
        <![CDATA[
            SELECT msg_id, code_key, domain_type, msg_type, module, description, message, status
            FROM CM_MESSAGE
            WHERE 1=1 AND status != 'CMSTAT002'
            <#if domainType??> AND domain_type = :domainType</#if>
            <#if msgType??> AND msg_type = :msgType</#if>
            <#if module??> AND module = :module</#if>
        ]]>
    </sql>

    <sql key="querySystemParam" remarks="query system param sql">
        <![CDATA[
            select pid, domain_type , module, description, units,  value, param_type, is_mandatory,  can_update , max_length, status
            from
            cm_system_parameters
            where 1=1 and status = 'CMSTAT001'
            <#if domainType??> and domain_type = :domainType</#if>
            <#if module??> and module = :module</#if>
            <#if description??> and charindex(:description, description) >0</#if>
            <#if units??> and units = :units</#if>
            <#if value??> and value = :value</#if>
            <#if param_type??> and param_type = :param_type</#if>
            <#if is_mandatory??> and is_mandatory = :is_mandatory</#if>
            <#if can_update??> and can_update = :can_update</#if>
            <#if max_length??> and max_length = :max_length</#if>

            <#if status??> and status = :status</#if>
        ]]>
    </sql>


    <sql key="queryFullModeAuditTrail" remarks="query full reocrd for audit trail">
        <![CDATA[
            select audit_id,action_time, operation, nric_number, uen_id, moh_user_id, login_type, session_id, client_ip
            ,user_agent, application_number, license_number, module, function_name, programme_name, before_action,
            after_action, validation_fail_detail, view_params, failed_reason, [domain] from at_audit_trail
            where 1 = 1
            <#if operation??> and operation = :operation</#if>
            <#if nric_number??> and nric_number = :nricnumber</#if>
            <#if startDate??> and action_time >= CONVERT(datetime, :startDate, 103) </#if>
            <#if endDate??> and action_time <= CONVERT(datetime, :endDate, 103) </#if>
            <#if operationType??> and [domain] = :operationType </#if>
        ]]>
    </sql>

    <sql key="queryDataMaskModeAuditTrail" remarks="query data mask for audit trail">
        <![CDATA[
            select audit_id,action_time, operation, nric_number, uen_id, moh_user_id, login_type, session_id, client_ip
            ,user_agent, application_number, license_number, module, function_name, programme_name, before_action,
            after_action, validation_fail_detail, view_params, failed_reason, [domain] from at_audit_trail
            where 1 = 1 and operation not in(4, 9, 11, 12, 13, 14, 15, 16, 18, 19, 20, 21, 22, 23, 24 )
            <#if operation??> and operation = :operation</#if>
            <#if nric_number??> and nric_number = :nricnumber</#if>
            <#if startDate??> and action_time >= CONVERT(datetime, :startDate, 103) </#if>
            <#if endDate??> and action_time <= CONVERT(datetime, :endDate, 103) </#if>
            <#if operationType??> and [domain] = :operationType </#if>
        ]]>
    </sql>

    <sql key = "queryHcsaService" remarks="query hcsa service parameter of checklist">
        <![CDATA[
            select stype.id as service_id, scategory.id as category_id, scategory.name as category_name, stype.name as service_name
            from iais.dbo.hcsa_service_type stype, iais.dbo.hcsa_service_category scategory where stype.category_id = scategory.id
        ]]>
    </sql>

    <sql key="listChklItem"  remarks="query chechlist items">
        <![CDATA[
                select item.id as item_id, regulation.clause_no as clause_num, regulation.clause as clause,
                item.question as checklistitem, item.answer_type as answer_type, item.risk_level as risk_level,
                item.status as status from chkl_config_hcsa_svc_item_pool item, chkl_config_hcsa_svc_regulation regulation where 1 = 1
                and item.regulation_id = regulation.id and item.status = 'cmstat001'
                <#if itemid??> and charindex(:itemid, item.id) >0</#if>
                <#if regulationclauseno??> and charindex(:regulationclauseno, regulation.clause_no) >0 </#if>
                <#if regulationclause??> and charindex(:regulationclause, regulation.clause) >0 </#if>
                <#if checklistItem??> and charindex(:checklistItem, item.question) >0</#if>
                <#if answertype??> and item.answer_type = :answertype</#if>
                <#if risklevel??> and item.risk_level = :risklevel</#if>
                <#if status??> and item.status = :status</#if>
        ]]>

    </sql>

    <sql key="listChecklistItemByItemId"  remarks="query chechlist items by item id">
        <![CDATA[
                select item.id as item_id, regulation.clause_no as clause_num, regulation.clause as clause,
                item.question as checklistitem, item.answer_type as answer_type, item.risk_level as risk_level,
                item.status as status from chkl_config_hcsa_svc_item_pool item, chkl_config_hcsa_svc_regulation regulation where 1 = 1
                and item.regulation_id = regulation.id and item.status = 'cmstat001'
                <#if itemid??> item.id in(:itemid)</#if>
        ]]>
    </sql>

    <sql key="templatesQuery"  remarks="QUERY MESSAGE TEMPLATE">
        <![CDATA[
            SELECT
                id,
                message_type,
                template_name,
                message_content,
                delivery_mode,
                effective_from,
                effective_to
            FROM message_template
            WHERE 1=1
            <#if id??> and charindex(:id, id) >0</#if>
            <#if msgType??> AND message_type = :msgType</#if>
            <#if templateName??> AND template_name = :templateName</#if>
            <#if deliveryMode??> AND delivery_mode = :deliveryMode</#if>
            <#if esd??> AND effective_from > :esd</#if>
            <#if eed??> AND effective_to < :eed</#if>
        ]]>
    </sql >

    <sql key="getBlackedOutDateList"  remarks="Get blacked out date list">
        <![CDATA[
            select T1.ID AS ID,
            T1.SRC_SYSTEM_ID AS SRC_SYSTEM_ID,
            T1.GROUP_SHORT_NAME AS GROUP_SHORT_NAME,
            T1.START_DATE AS START_DATE,
            T1.END_DATE AS END_DATE,
            T1.[DESC] as [DESC],
            T1.STATUS as STATUS
            from appt_blackout_date T1, appt_src_system T2
            where T1.SRC_SYSTEM_ID = T2.ID
            AND T1.STATUS in ('CMSTAT001','CMSTAT003')
            <#if shortName??> AND T1.GROUP_SHORT_NAME = :shortName</#if>
            <#if startDate??> AND T1.START_DATE > :startDate</#if>
            <#if endDate??> AND T1.END_DATE < :endDate</#if>
            <#if status??> AND T1.STATUS < :status</#if>
            <#if bkStartDate??> AND T1.START_DATE > CONVERT(datetime, :bkStartDate, 103)</#if>
            <#if bkEndDate??> AND T1.END_DATE > CONVERT(datetime, :bkEndDate, 103)</#if>
        ]]>
    </sql>

    <sql key="getWorkingGroupByUserId">
        <![CDATA[
            select DISTINCT T3.ID AS id,
            T3.group_name as group_name,
            T3.group_domain AS group_domain,
            T3.STATUS AS STATUS
            from
            user_group_correlation T1,
            user_account T2,
            working_group T3
            where T1.user_id = T2.ID
            and T2.USER_DOMAIN = 'intranet'
            and T3.id = T1.group_id
            and T3.group_name in('Inspection Stage 001', 'Inspection Stage 002', 'Inspection Stage 003', 'Inspection Stage 004')
            and T1.IS_GRP_LEADER = 1
            <#if userId??> AND T1.user_id = :userId</#if>
        ]]>
    </sql>
    <sql key="getHolidayList"  remarks="Get public holiday">
        <![CDATA[
            select
            id,FROM_DATE,TO_DATE,DESCRIPTION,STATUS
            from public_holiday
            WHERE  status = 'CMSTAT001'
            <#if description??> AND DESCRIPTION like :description</#if>
            <#if year??> AND (FROM_DATE like :year or TO_DATE like :year)</#if>
        ]]>
    </sql>

    <sql key="queryInspectorCalendar"  remarks="Query Inspector Calendar">
        <![CDATA[
            SELECT
            T3.ID as ID,
            SUBSTRING(CONVERT(varchar(100),T3.BLOCK_OUT_END, 20), 0,5) AS YEAR,
            T2.NAME AS NAME,
            T3.BLOCK_OUT_START as BLOCK_OUT_START,
            T3.BLOCK_OUT_END AS BLOCK_OUT_END,
            T3.REMARKS AS REMARKS
            FROM appt_user_system_correlation T1
            JOIN appt_agency_user T2 ON T1.AGENCY_USER_ID = T2.ID
            JOIN appt_user_non_avail T3 ON T1.ID = T3.USER_SYS_CORRE_ID
            <#if wrkGroup??> AND T1.GROUP_SHORT_NAME = :wrkGroup </#if>
            <#if userName??> AND charindex(:userName, T2.NAME) >0</#if>
            <#if userBlockDateStart??> AND T3.BLOCK_OUT_START > CONVERT(datetime, :userBlockDateStart, 103)</#if>
            <#if userBlockDateEnd??> AND T3.BLOCK_OUT_END < CONVERT(datetime, :userBlockDateEnd, 103)</#if>
            <#if userBlockDateDescription??> AND charindex(:userBlockDateDescription, T3.REMARKS) >0 </#if>
            <#if year??>
                    AND T3.BLOCK_OUT_START > CONVERT(datetime, :year, 20)
                    AND T3.BLOCK_OUT_END < dateadd(day, 365, CONVERT(datetime, :year, 20))
             </#if>
        ]]>
    </sql>
</sqls>

