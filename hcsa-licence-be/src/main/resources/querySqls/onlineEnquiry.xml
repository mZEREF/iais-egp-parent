<?xml version="1.0" encoding="UTF-8"?>
<sqls catalog="onlineEnquiry">
    <sql key = "searchByProfessionalInfo" remarks="search by professional information">
        <![CDATA[
            select distinct a.id, a.name, a.prof_reg_no, b.practice_location, b.licence_no, b.service_name, a.designation, a.psn_type
            from
            (
            select
            t3.id,
            t1.licence_id as licence_id,
            t2.name as name,
            t3.prof_reg_no as prof_reg_no,
            t2.designation as designation,
            t1.psn_type as psn_type,
            t4.licence_no,
            t4.svc_name
            from lic_key_personnel t1
            join  key_personnel t2 on t1.person_id = t2.id
            join key_personnel_ext t3 on t1.psn_ext_id = t3.id and t3.person_id = t2.id
            join licence t4 on t1.licence_id = t4.id) a,
            (
            select distinct
            t3.id,
            t3.licence_no,
            t3.svc_name as service_name,
            t2.hci_code as hci_code,
            t2.postal_code as postal_code,
            t2.hci_name as hci_name,
            concat(t2.blk_no ,
                '/',
                case t2.street_name
                  when null then null
                  when '' then null
              else ''+ t2.street_name end
               , case t2.building_name
                  when null then null
                  when '' then null
              else ' '+t2.building_name end
               , case t2.floor_no
                  when null then null
                  when '' then null
              else ' #'+t2.floor_no end
               , case t2.unit_no
                  when null then null
                  when '' then null
              else '-'+t2.unit_no end,
                SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =t2.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,
               case t2.postal_code
                  when null then null
                  when '' then null
              else ', '+t2.postal_code end
              ) as practice_location
            from lic_premises t1
            join premises t2 on t1.premises_id = t2.id
            join licence t3 on t1.licence_id = t3.id
            join (select licence_no,
            max(version) as version from licence group by licence_no) inner_lic on inner_lic.licence_no = t3.licence_no and inner_lic.version = t3.version
            ) b
            where a.licence_id = b.id
            <#if id??> AND a.id = :id >0 </#if>
            <#if filterIdList??> and ${filterIdList} </#if>
            <#if name??> AND charindex(:name, a.name) >0 </#if>
            <#if profRegNo??> AND charindex(:profRegNo, a.prof_reg_no) >0</#if>
            <#if postalCode??> AND charindex(:postalCode, b.postal_code) >0</#if>
            <#if address??> AND  charindex(:address, b.practice_location) >0</#if>
            <#if hciName??> AND charindex(:hciName, b.hci_name) >0 </#if>
            <#if hciCode??> AND charindex(:hciCode, b.hci_code) >0</#if>
            <#if hciPostalcode??> AND charindex(:hciPostalcode, b.postal_code)  >0 </#if>
            <#if practiceLocation??> AND charindex(:practiceLocation, b.practice_location ) >0 </#if>
            <#if serviceName??> AND b.service_name = :serviceName</#if>
            <#if designation??> AND charindex(:designation, a.designation) >0 </#if>
            <#if role??> AND a.psn_type = :role</#if>
        ]]>
    </sql>

    <sql key = "searchSubmissionByAssistedReproduction" remarks="search submission by Assisted Reproduction">
        <![CDATA[
            SELECT distinct dds.ID, dds.SUBMISSION_NO, dds.SUBMISSION_TYPE, dds.CYCLE_STAGE, dds.SUBMIT_DT ,lp.BUSINESS_NAME ,dc.PATIENT_CODE
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID

                where 1=1
            <#if arCentre??> AND  charindex(:arCentre, lp.BUSINESS_NAME) >0</#if>
            <#if submissionId??> AND  charindex(:submissionId, dds.SUBMISSION_NO) >0</#if>
            <#if submissionType??> AND  charindex(:submissionType, dds.SUBMISSION_TYPE) >0</#if>
            <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
            <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(date,:submission_to_date)</#if>
         ]]>
      </sql>


    <sql key = "searchPatientByAssistedReproduction" remarks="search patient by Assisted Reproduction">
        <![CDATA[
           SELECT distinct dpi.ID, dpi.NAME, dpi.ID_TYPE, dpi.ID_NUMBER, dpi.DATE_OF_BIRTH, dpi.NATIONALITY,null CREATED_DT ,null BUSINESS_NAME,dpi.PATIENT_CODE
                FROM ds_patient_information dpi
                join ds_cycle dc on dc.PATIENT_CODE =dpi.PATIENT_CODE
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                where 1=1
            <#if arCentre??> AND  charindex(:arCentre, lp.BUSINESS_NAME) >0</#if>
            <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
            <#if patientIdNumber??> AND  charindex(:patientIdNumber, dpi.ID_NUMBER) >0</#if>
            <#if patient_id_types??> AND  ${patient_id_types}</#if>

        ]]>
     </sql>


    <sql key = "searchPatientAjaxByAssistedReproduction" remarks="search patient ajax by Assisted Reproduction">
        <![CDATA[
           SELECT distinct ajax.* FROM (
            SELECT dc.ID ,dpi.ID patient_id, 'AR' DS_TYPE ,dacs.TREATMENT_FRESH_NATURAL ,dacs.TREATMENT_FRESH_STIMULATED ,dacs.TREATMENT_FROZEN_EMBRYO ,dacs.TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE, lp.BUSINESS_NAME ,dacs.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission dds on dds.CYCLE_ID = dc.ID
                join ds_ar_cycle_stage dacs on dacs.SUBMISSION_ID =dds.ID
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID

                UNION ALL
                SELECT dc.ID,dpi.ID patient_id,'IUI' DS_TYPE ,null TREATMENT_FRESH_NATURAL ,null TREATMENT_FRESH_STIMULATED ,null TREATMENT_FROZEN_EMBRYO ,null TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE, lp.BUSINESS_NAME ,dics.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission dds on dds.CYCLE_ID = dc.ID
                join ds_iui_cycle_stage dics on dics.SUBMISSION_ID =dds.ID
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                UNION ALL
                SELECT dc.ID,dpi.ID patient_id,'EFO' DS_TYPE ,null TREATMENT_FRESH_NATURAL ,null TREATMENT_FRESH_STIMULATED ,null TREATMENT_FROZEN_EMBRYO ,null TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE, lp.BUSINESS_NAME ,decs.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission dds on dds.CYCLE_ID = dc.ID
                join ds_efo_cycle_stage decs  on decs.SUBMISSION_ID =dds.ID
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
            ) ajax
            where 1=1
            <#if patientId??> AND  :patientId = ajax.patient_id</#if>

        ]]>
    </sql>

    <sql key = "advancedSearchPatientByAssistedReproduction" remarks="Advanced Search patient by Assisted Reproduction">
        <![CDATA[
           SELECT distinct dpi.ID, dpi.NAME, dpi.ID_TYPE, dpi.ID_NUMBER, dpi.DATE_OF_BIRTH, dpi.NATIONALITY,dpi.CREATED_DT ,lp.BUSINESS_NAME,dpi.PATIENT_CODE
                FROM ds_patient_information dpi
                join ds_cycle dc on dc.PATIENT_CODE =dpi.PATIENT_CODE
                join premises p on dc.HCI_CODE =p.HCI_CODE
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                join ds_data_submission dds on dds.CYCLE_ID=dc.ID
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_ar_cycle_stage dacs on dacs.SUBMISSION_ID=dds.ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_donor_sample donor on donor.SUBMISSION_ID=dds.ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where 1=1
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patientIdType??> AND  charindex(:patientIdType, dpi.ID_TYPE) >0</#if>
                <#if patientIdNumber??> AND  charindex(:patientIdNumber, dpi.ID_NUMBER) >0</#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  charindex(:submissionId, dds.SUBMISSION_NO) >0</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(date,:submission_to_date)</#if>

                <#if husbandName??> AND  charindex(:husbandName, dh.NAME) >0</#if>
                <#if husbandIdType??> AND  charindex(:husbandIdType, dh.ID_TYPE) >0</#if>
                <#if husbandIdNumber??> AND  charindex(:husbandIdNumber, dh.ID_NUMBER) >0</#if>

                <#if arCentre??> AND  charindex(:arCentre, lp.BUSINESS_NAME) >0</#if>
                <#if embryologist??> AND  charindex(:embryologist, dacs.EMBRYOLOGIST) >0</#if>
                <#if arPractitioner??> AND  charindex(:arPractitioner, dacs.PRACTITIONER) >0</#if>

                <#if cycleStagesStatus??> AND  charindex(:cycleStagesStatus, dc.STATUS) >0</#if>
                <#if cycleStagesDateFrom??> AND dc.CREATED_DT >= convert(date,:cycleStagesDateFrom)</#if>
                <#if cycleStagesDateTo??> AND dc.CREATED_DT <= convert(date,:cycleStagesDateTo)</#if>
                <#if arOrIui??> AND  charindex(:arOrIui, dc.DS_TYPE) >0</#if>
                <#if ivm??> AND  :ivm = dacs.IN_VITRO_MATURATION </#if>
                <#if cart_fcn??> AND  :cart_fcn = dacs.TREATMENT_FRESH_NATURAL </#if>
                <#if cart_fcs??> AND  :cart_fcs = dacs.TREATMENT_FRESH_STIMULATED </#if>
                <#if cart_foc??> AND  :cart_foc = dacs.TREATMENT_FROZEN_OOCYTE </#if>
                <#if cart_foe??> AND  :cart_foe = dacs.TREATMENT_FROZEN_EMBRYO </#if>
                <#if freshCycleNumFrom??> AND  :freshCycleNumFrom <= dacs.TOTAL_PREVIOUSLY_PREVIOUSLY </#if>
                <#if freshCycleNumTo??> AND  :freshCycleNumTo >= dacs.TOTAL_PREVIOUSLY_PREVIOUSLY </#if>
                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  charindex(:donorName, donor.DONOR_NAME) >0</#if>
                <#if donorIdNumber??> AND  charindex(:donorIdNumber, donor.ID_NUMBER) >0</#if>
                <#if FROM_DONOR??> AND  :FROM_DONOR = dfs.IS_FROM_DONOR </#if>
                <#if FROM_DONOR_TISSUE??> AND  :FROM_DONOR_TISSUE = dfs.IS_FROM_DONOR_TISSUE </#if>
                <#if FROM_HUSBAND??> AND  :FROM_HUSBAND = dfs.IS_FROM_HUSBAND </#if>
                <#if FROM_HUSBAND_TISSUE??> AND  :FROM_HUSBAND_TISSUE = dfs.IS_FROM_HUSBAND_TISSUE </#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dfs.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dfs.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dfs.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dfs.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(date,:deliveryDateTo)</#if>
                <#if patientART??> AND  :patientART = datss.ART_CO_FUNDING </#if>
                <#if patientIUI??> AND  :patientIUI = ditss.IUI_CO_FUNDING </#if>
                <#if patientPGT??> AND  :patientPGT = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(date,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredList??> AND  (:transferredOocyte <= dtios.EMBRYO_NUM or :transferredEmbryo <= dtios.SPERM_VIALS_NUM or :transferredSperm <= dtios.OOCYTE_NUM) </#if>
                <#if transferredInFrom??> AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(date,:transferDateTo)</#if>
                <#if pgtNo??> AND  dps.ID is null </#if>
                <#if pgtYes??> AND  dps.ID is not null </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>


        ]]>
    </sql>


    <sql key = "ar-quick-view" remarks="search patient by Assisted Reproduction quick view">
        <![CDATA[
            <div class="arQuickView">
                <div class="row">Co-funding History</div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        Total No. of Co-funded IUI Cycles
                    </div>
                    <div class="col-md-6">
                        IUICyclesNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Total No. of Co-funded ART Fresh Cycles
                    </div>
                    <div class="col-md-6">
                        FreshCyclesNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Total No. of Co-funded ART Frozen Cycles
                    </div>
                    <div class="col-md-6">
                        FrozenCyclesNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Total No. of Co-funded PGT Cycles
                    </div>
                    <div class="col-md-6">
                        PGTCyclesNumber
                    </div>
                </div>
                <hr>
                <div class="row">Total Inventory</div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        Fresh Oocytes
                    </div>
                    <div class="col-md-6">
                        FreshOocytesNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Frozen Oocytes
                    </div>
                    <div class="col-md-6">
                        FrozenOocytesNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Fresh Embryos
                    </div>
                    <div class="col-md-6">
                        FreshEmbryosNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Frozen Embryos
                    </div>
                    <div class="col-md-6">
                        FrozenEmbryosNumber
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        Frozen Sperms
                    </div>
                    <div class="col-md-6">
                        FrozenSpermsNumber
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <a href="#" onclick="fullDetailsView('patientId')">View Full Details</a>
                    </div>
                </div>

            </div>


        ]]>
    </sql>
</sqls>