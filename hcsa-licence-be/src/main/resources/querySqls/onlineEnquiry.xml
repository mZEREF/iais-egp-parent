<?xml version="1.0" encoding="UTF-8"?>
<sqls catalog="onlineEnquiry">
    <sql key = "searchByProfessionalInfo" remarks="search by professional information">
        <![CDATA[
            select distinct a.id, a.name, a.prof_reg_no, b.practice_location, b.licence_no, b.service_name, a.designation, a.psn_type
            from
            (
            select
            t3.id,
            t1.licence_id as licence_id,
            t2.name as name,
            t3.prof_reg_no as prof_reg_no,
            t2.designation as designation,
            t1.psn_type as psn_type,
            t4.licence_no,
            t4.svc_name
            from lic_key_personnel t1
            join  key_personnel t2 on t1.person_id = t2.id
            join key_personnel_ext t3 on t1.psn_ext_id = t3.id and t3.person_id = t2.id
            join licence t4 on t1.licence_id = t4.id) a,
            (
            select distinct
            t3.id,
            t3.licence_no,
            t3.svc_name as service_name,
            t2.hci_code as hci_code,
            t2.postal_code as postal_code,
            t2.hci_name as hci_name,
            concat(t2.blk_no ,
                '/',
                case t2.street_name
                  when null then null
                  when '' then null
              else ''+ t2.street_name end
               , case t2.building_name
                  when null then null
                  when '' then null
              else ' '+t2.building_name end
               , case t2.floor_no
                  when null then null
                  when '' then null
              else ' #'+t2.floor_no end
               , case t2.unit_no
                  when null then null
                  when '' then null
              else '-'+t2.unit_no end,
                SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =t2.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,
               case t2.postal_code
                  when null then null
                  when '' then null
              else ', '+t2.postal_code end
              ) as practice_location
            from lic_premises t1
            join premises t2 on t1.premises_id = t2.id
            join licence t3 on t1.licence_id = t3.id
            join (select licence_no,
            max(version) as version from licence group by licence_no) inner_lic on inner_lic.licence_no = t3.licence_no and inner_lic.version = t3.version
            ) b
            where a.licence_id = b.id
            <#if id??> AND a.id = :id >0 </#if>
            <#if filterIdList??> and ${filterIdList} </#if>
            <#if name??> AND charindex(:name, a.name) >0 </#if>
            <#if profRegNo??> AND charindex(:profRegNo, a.prof_reg_no) >0</#if>
            <#if postalCode??> AND charindex(:postalCode, b.postal_code) >0</#if>
            <#if address??> AND  charindex(:address, b.practice_location) >0</#if>
            <#if hciName??> AND charindex(:hciName, b.hci_name) >0 </#if>
            <#if hciCode??> AND charindex(:hciCode, b.hci_code) >0</#if>
            <#if hciPostalcode??> AND charindex(:hciPostalcode, b.postal_code)  >0 </#if>
            <#if practiceLocation??> AND charindex(:practiceLocation, b.practice_location ) >0 </#if>
            <#if serviceName??> AND b.service_name = :serviceName</#if>
            <#if designation??> AND charindex(:designation, a.designation) >0 </#if>
            <#if role??> AND a.psn_type = :role</#if>
        ]]>
    </sql>

</sqls>