<?xml version="1.0" encoding="UTF-8"?>
<sqls catalog="onlineEnquiry">
    <sql key = "searchByProfessionalInfo" remarks="search by professional information">
        <![CDATA[
            select distinct a.id, a.name, a.prof_reg_no, b.practice_location, b.licence_no, b.service_name, a.designation, a.psn_type
            from
            (
            select
            p.id,
            t1.licence_id as licence_id,
            t2.name as name,
            p.prof_reg_no as prof_reg_no,
            t2.designation as designation,
            t1.psn_type as psn_type,
            t4.licence_no,
            t4.svc_name
            from lic_key_personnel t1
            join  key_personnel t2 on t1.person_id = t2.id
            join key_personnel_ext t3 on t1.psn_ext_id = p.id and p.person_id = t2.id
            join licence t4 on t1.licence_id = t4.id) a,
            (
            select distinct
            p.id,
            p.licence_no,
            p.svc_name as service_name,
            t2.hci_code as hci_code,
            t2.postal_code as postal_code,
            t2.hci_name as hci_name,
            concat(t2.blk_no ,
                '/',
                case t2.street_name
                  when null then null
                  when '' then null
              else ''+ t2.street_name end
               , case t2.building_name
                  when null then null
                  when '' then null
              else ' '+t2.building_name end
               , case t2.floor_no
                  when null then null
                  when '' then null
              else ' #'+t2.floor_no end
               , case t2.unit_no
                  when null then null
                  when '' then null
              else '-'+t2.unit_no end,
                SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =t2.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,
               case t2.postal_code
                  when null then null
                  when '' then null
              else ', '+t2.postal_code end
              ) as practice_location
            from lic_premises t1
            join premises t2 on t1.premises_id = t2.id
            join licence t3 on t1.licence_id = p.id
            join (select licence_no,
            max(version) as version from licence group by licence_no) inner_lic on inner_lic.licence_no = p.licence_no and inner_lic.version = p.version
            ) b
            where a.licence_id = b.id
            <#if id??> AND a.id = :id >0 </#if>
            <#if filterIdList??> and ${filterIdList} </#if>
            <#if name??> AND charindex(:name, a.name) >0 </#if>
            <#if profRegNo??> AND charindex(:profRegNo, a.prof_reg_no) >0</#if>
            <#if postalCode??> AND charindex(:postalCode, b.postal_code) >0</#if>
            <#if address??> AND  charindex(:address, b.practice_location) >0</#if>
            <#if hciName??> AND charindex(:hciName, b.hci_name) >0 </#if>
            <#if hciCode??> AND charindex(:hciCode, b.hci_code) >0</#if>
            <#if hciPostalcode??> AND charindex(:hciPostalcode, b.postal_code)  >0 </#if>
            <#if practiceLocation??> AND charindex(:practiceLocation, b.practice_location ) >0 </#if>
            <#if serviceName??> AND b.service_name = :serviceName</#if>
            <#if designation??> AND charindex(:designation, a.designation) >0 </#if>
            <#if role??> AND a.psn_type = :role</#if>
        ]]>
    </sql>

    <sql key = "searchSubmissionByAssistedReproduction" remarks="search submission by Assisted Reproduction">
        <![CDATA[
        SELECT distinct tt.* from (
        SELECT  dds.ID, dds.SUBMISSION_NO, dds.SUBMISSION_TYPE, case dds.SUBMISSION_TYPE when 'AR_TP002' then  dds.CYCLE_STAGE  else '-' end as CYCLE_STAGE, dds.SUBMIT_DT ,
            CONCAT(case lp.BUSINESS_NAME when null then '-, ' when '' then '-, ' else lp.BUSINESS_NAME + ', ' end ,
                  case p.BLK_NO when null then null else ''+p.BLK_NO end ,
               case p.STREET_NAME when null then null else ' '+p.STREET_NAME end ,
               case p.BUILDING_NAME when null then null else ' '+p.BUILDING_NAME end
               , case p.FLOOR_NO when null then null else ' #'+p.FLOOR_NO end
               , case p.UNIT_NO when null then null else '-'+p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case p.POSTAL_CODE
                  when null then null
                  else ', '+p.POSTAL_CODE end
              ) AS BUSINESS_NAME ,dc.PATIENT_CODE
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART' and dc.HCI_CODE not in (select ar_cen.HCI_CODE from ds_center ar_cen where ar_cen.CENTER_TYPE ='ART')
                join premises p on dc.HCI_CODE =p.HCI_CODE and  p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dc.HCI_CODE)
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                where dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
            <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>
            <#if submissionType??> AND  charindex(:submissionType, dds.SUBMISSION_TYPE) >0</#if>
            <#if cycleStage??> AND  charindex(:cycleStage, dds.CYCLE_STAGE) >0</#if>
            <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
            <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>
            UNION ALL
            SELECT  dds.ID, dds.SUBMISSION_NO, dds.SUBMISSION_TYPE, case dds.SUBMISSION_TYPE when 'AR_TP002' then  dds.CYCLE_STAGE  else '-' end as CYCLE_STAGE, dds.SUBMIT_DT ,
            CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS BUSINESS_NAME ,dc.PATIENT_CODE
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART'
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dc.DS_TYPE =dcen.CENTER_TYPE
                where dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
            <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>
            <#if submissionType??> AND  charindex(:submissionType, dds.SUBMISSION_TYPE) >0</#if>
            <#if cycleStage??> AND  charindex(:cycleStage, dds.CYCLE_STAGE) >0</#if>
            <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
            <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>
        ) tt

         ]]>
    </sql>


    <sql key = "searchPatientByAssistedReproduction" remarks="search patient by Assisted Reproduction">
        <![CDATA[
             SELECT distinct dpi.ID, dpi.NAME, dpi.ID_TYPE, dpi.ID_NUMBER, dpi.DATE_OF_BIRTH, dpi.NATIONALITY,dc2.PATIENT_CODE CD_PATIENT_CODE,dpi.PATIENT_CODE
                FROM ds_patient_information dpi
                join ds_data_submission dds on (dds.ID = dpi.SUBMISSION_ID or dds.CYCLE_ID in(select dcp.ID from ds_cycle dcp where dcp.PATIENT_CODE = dpi.PATIENT_CODE)) AND dds.STATUS in ('DS001', 'DS011')
                JOIN ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART'
                left join ds_cycle dc2 on dc2.PATIENT_CODE = dpi.PATIENT_CODE
                where 1=1
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter </#if>
            <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
            <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
            <#if patient_id_types??> AND  ${patient_id_types}</#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>

        ]]>
     </sql>


    <sql key = "searchPatientAjaxByAssistedReproduction" remarks="search patient ajax by Assisted Reproduction">
        <![CDATA[
           SELECT distinct ajax.* FROM (
                SELECT dc.ID ,dpi.PATIENT_CODE patient_code, 'AR' DS_TYPE ,dacs.TREATMENT_FRESH_NATURAL ,dacs.TREATMENT_FRESH_STIMULATED ,dacs.TREATMENT_FROZEN_EMBRYO ,dacs.TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE,
            CONCAT(case lp.BUSINESS_NAME when null then '-, ' when '' then '-, ' else lp.BUSINESS_NAME + ', ' end ,
                  case p.BLK_NO when null then null else ''+p.BLK_NO end ,
               case p.STREET_NAME when null then null else ' '+p.STREET_NAME end ,
               case p.BUILDING_NAME when null then null else ' '+p.BUILDING_NAME end
               , case p.FLOOR_NO when null then null else ' #'+p.FLOOR_NO end
               , case p.UNIT_NO when null then null else '-'+p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case p.POSTAL_CODE
                  when null then null
                  else ', '+p.POSTAL_CODE end
              ) AS BUSINESS_NAME ,dc.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission ddsAcs on ddsAcs.CYCLE_ID = dc.ID and ddsAcs.STATUS not in ('DS002','DS012')
                join ds_ar_cycle_stage dacs on dacs.SUBMISSION_ID =ddsAcs.ID
                join premises p on dc.HCI_CODE =p.HCI_CODE and  p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dc.HCI_CODE)
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                left join ds_data_submission dds on dds.CYCLE_ID = dc.ID and dds.STATUS not in ('DS002','DS012')
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_ar_donor dad on dad.CYCLE_STAGE_ID = dacs.ID
                left join ds_donor_sample dad_donor on dad_donor.ID=dad.DONOR_SAMPLE_ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transfer_stage dets on dets.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where dc.CYCLE_TYPE ='DSCL_008' and dc.HCI_CODE not in (select ar_cen.HCI_CODE from ds_center ar_cen where ar_cen.CENTER_TYPE ='ART')
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patient_id_types??> AND  ${patient_id_types}</#if>
                <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>

                <#if husbandName??> AND charindex(:husbandName, dh.NAME) >0 </#if>
                <#if husband_id_types??> AND  ${husband_id_types}</#if>
                <#if husbandIdNumber??> AND  :husbandIdNumber = dh.ID_NUMBER</#if>

                <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
                <#if embryologist??> AND  charindex(:embryologist, dacs.EMBRYOLOGIST) >0</#if>
                <#if arPractitioner??> AND  charindex(:arPractitioner, dacs.PRACTITIONER) >0</#if>

                <#if cycleStagesStatus??> AND  :cycleStagesStatus = dc.STATUS </#if>
                <#if cycleStagesFinalStatus??> AND  :cycleStagesFinalStatus = 'DS003' and dc.STATUS in ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') </#if>
                <#if indicationArCycleList??> AND  ${indicationArCycleList}</#if>
                <#if cycleStagesDateFrom??> AND (dacs.START_DATE >= convert(date,:cycleStagesDateFrom))</#if>
                <#if cycleStagesDateTo??> AND ( dacs.START_DATE <= convert(datetime,:cycleStagesDateTo) )</#if>
                <#if arOrIui??> AND :arOrIui = dc.CYCLE_TYPE </#if>
                <#if ivm??> AND  :ivm = dacs.IN_VITRO_MATURATION </#if>
                <#if cart_fcn??> AND  :cart_fcn = dacs.TREATMENT_FRESH_NATURAL </#if>
                <#if cart_fcs??> AND  :cart_fcs = dacs.TREATMENT_FRESH_STIMULATED </#if>
                <#if cart_foc??> AND  :cart_foc = dacs.TREATMENT_FROZEN_OOCYTE </#if>
                <#if cart_foe??> AND  :cart_foe = dacs.TREATMENT_FROZEN_EMBRYO </#if>
                <#if freshCycleNumFrom??> AND  :freshCycleNumFrom <= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE )  </#if>
                <#if freshCycleNumTo??> AND  :freshCycleNumTo >= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE ) </#if>

                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  (charindex(:donorName, dad_donor.DONOR_NAME) >0 )</#if>
                <#if donorIdNumber??> AND  (:donorIdNumber = dad_donor.ID_NUMBER )</#if>
                <#if donor_id_types_ar??> AND (  ${donor_id_types_ar} )</#if>
                <#if donorUsedYes??> AND :donorUsedYes = 1 and dds.ID in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID ) </#if>
                <#if donorUsedNo??> AND :donorUsedNo = 0 and dds.ID not in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID ) </#if>
                <#if FROM_DONOR??> AND  (:FROM_DONOR = dfs.IS_FROM_DONOR or :FROM_DONOR = dfs.IS_FROM_DONOR_TISSUE ) </#if>
                <#if FROM_HUSBAND??> AND  (:FROM_HUSBAND = dfs.IS_FROM_HUSBAND or :FROM_HUSBAND = dfs.IS_FROM_HUSBAND_TISSUE)</#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dets.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dets.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dets.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dets.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(datetime,:deliveryDateTo)</#if>
                <#if patientArtYes??> AND :patientArtYes = 1 AND 'ATSACF002' = datss.ART_CO_FUNDING or 'ATSACF003' = datss.ART_CO_FUNDING </#if>
                <#if patientArtNo??> AND :patientArtNo = 1 AND 'ATSACF001' = datss.ART_CO_FUNDING </#if>
                <#if patientPgtYes??> AND :patientPgtYes = 1 and 1 = dps.IS_PGT_CONFUNDING </#if>
                <#if patientPgtNo??> AND :patientPgtNo = 1 and 0 = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(datetime,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredOocyte??> AND  :transferredOocyte <= dtios.OOCYTE_NUM </#if>
                <#if transferredEmbryo??> AND  :transferredEmbryo <= dtios.EMBRYO_NUM </#if>
                <#if transferredSperm??> AND  :transferredSperm <= dtios.SPERM_VIALS_NUM </#if>
                <#if transferredInFrom??> AND TRANSFER_TYPE ='in' AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND TRANSFER_TYPE ='out' AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(datetime,:transferDateTo)</#if>
                <#if pgtNo??> AND :pgtNo = 1 AND dpi.PATIENT_CODE not in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtYes??> AND :pgtYes = 1 AND dpi.PATIENT_CODE  in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>
                UNION ALL
                SELECT dc.ID ,dpi.PATIENT_CODE patient_code, 'AR' DS_TYPE ,dacs.TREATMENT_FRESH_NATURAL ,dacs.TREATMENT_FRESH_STIMULATED ,dacs.TREATMENT_FROZEN_EMBRYO ,dacs.TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE,
            CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS BUSINESS_NAME  ,dc.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission ddsAcs on ddsAcs.CYCLE_ID = dc.ID and ddsAcs.STATUS not in ('DS002','DS012')
                join ds_ar_cycle_stage dacs on dacs.SUBMISSION_ID =ddsAcs.ID
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dc.DS_TYPE =dcen.CENTER_TYPE
                left join ds_data_submission dds on dds.CYCLE_ID = dc.ID and dds.STATUS not in ('DS002','DS012')
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_ar_donor dad on dad.CYCLE_STAGE_ID = dacs.ID
                left join ds_donor_sample dad_donor on dad_donor.ID=dad.DONOR_SAMPLE_ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transfer_stage dets on dets.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where dc.CYCLE_TYPE ='DSCL_008'
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patient_id_types??> AND  ${patient_id_types}</#if>
                <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>

                <#if husbandName??> AND charindex(:husbandName, dh.NAME) >0 </#if>
                <#if husband_id_types??> AND  ${husband_id_types}</#if>
                <#if husbandIdNumber??> AND  :husbandIdNumber = dh.ID_NUMBER</#if>

                <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
                <#if embryologist??> AND  charindex(:embryologist, dacs.EMBRYOLOGIST) >0</#if>
                <#if arPractitioner??> AND  charindex(:arPractitioner, dacs.PRACTITIONER) >0</#if>

                <#if cycleStagesStatus??> AND  :cycleStagesStatus = dc.STATUS </#if>
                <#if cycleStagesFinalStatus??> AND  :cycleStagesFinalStatus = 'DS003' and dc.STATUS in ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') </#if>
                <#if indicationArCycleList??> AND  ${indicationArCycleList}</#if>
                <#if cycleStagesDateFrom??> AND (dacs.START_DATE >= convert(date,:cycleStagesDateFrom) )</#if>
                <#if cycleStagesDateTo??> AND ( dacs.START_DATE <= convert(datetime,:cycleStagesDateTo) )</#if>
                <#if arOrIui??> AND :arOrIui = dc.CYCLE_TYPE </#if>
                <#if ivm??> AND  :ivm = dacs.IN_VITRO_MATURATION </#if>
                <#if cart_fcn??> AND  :cart_fcn = dacs.TREATMENT_FRESH_NATURAL </#if>
                <#if cart_fcs??> AND  :cart_fcs = dacs.TREATMENT_FRESH_STIMULATED </#if>
                <#if cart_foc??> AND  :cart_foc = dacs.TREATMENT_FROZEN_OOCYTE </#if>
                <#if cart_foe??> AND  :cart_foe = dacs.TREATMENT_FROZEN_EMBRYO </#if>
                <#if freshCycleNumFrom??> AND  :freshCycleNumFrom <= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE )  </#if>
                <#if freshCycleNumTo??> AND  :freshCycleNumTo >= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE ) </#if>

                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  (charindex(:donorName, dad_donor.DONOR_NAME) >0 )</#if>
                <#if donorIdNumber??> AND  (:donorIdNumber = dad_donor.ID_NUMBER )</#if>
                <#if donor_id_types_ar??> AND (  ${donor_id_types_ar} )</#if>
                <#if donorUsedYes??> AND :donorUsedYes = 1 and dds.ID in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID ) </#if>
                <#if donorUsedNo??> AND :donorUsedNo = 0 and dds.ID not in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID ) </#if>
                <#if FROM_DONOR??> AND  (:FROM_DONOR = dfs.IS_FROM_DONOR or :FROM_DONOR = dfs.IS_FROM_DONOR_TISSUE ) </#if>
                <#if FROM_HUSBAND??> AND  (:FROM_HUSBAND = dfs.IS_FROM_HUSBAND or :FROM_HUSBAND = dfs.IS_FROM_HUSBAND_TISSUE)</#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dets.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dets.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dets.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dets.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(datetime,:deliveryDateTo)</#if>
                <#if patientArtYes??> AND :patientArtYes = 1 AND 'ATSACF002' = datss.ART_CO_FUNDING or 'ATSACF003' = datss.ART_CO_FUNDING </#if>
                <#if patientArtNo??> AND :patientArtNo = 1 AND 'ATSACF001' = datss.ART_CO_FUNDING </#if>
                <#if patientPgtYes??> AND :patientPgtYes = 1 and 1 = dps.IS_PGT_CONFUNDING </#if>
                <#if patientPgtNo??> AND :patientPgtNo = 1 and 0 = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(datetime,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredOocyte??> AND  :transferredOocyte <= dtios.OOCYTE_NUM </#if>
                <#if transferredEmbryo??> AND  :transferredEmbryo <= dtios.EMBRYO_NUM </#if>
                <#if transferredSperm??> AND  :transferredSperm <= dtios.SPERM_VIALS_NUM </#if>
                <#if transferredInFrom??> AND TRANSFER_TYPE ='in' AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND TRANSFER_TYPE ='out' AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(datetime,:transferDateTo)</#if>
                <#if pgtNo??> AND :pgtNo = 1 AND dpi.PATIENT_CODE not in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtYes??> AND :pgtYes = 1 AND dpi.PATIENT_CODE  in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>
                UNION ALL
                SELECT dc.ID,dpi.PATIENT_CODE patient_code,
                case dc.CYCLE_TYPE
                when 'DSCL_009' then 'IUI'
                when 'DSCL_010' then 'EFO'
                when 'DSCL_011' then '-'
                else '-' end
                as DS_TYPE ,null TREATMENT_FRESH_NATURAL ,null TREATMENT_FRESH_STIMULATED ,null TREATMENT_FROZEN_EMBRYO ,null TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE,
                CONCAT(case lp.BUSINESS_NAME when null then '-, ' when '' then '-, ' else lp.BUSINESS_NAME + ', ' end ,
                  case p.BLK_NO when null then null else ''+p.BLK_NO end ,
               case p.STREET_NAME when null then null else ' '+p.STREET_NAME end ,
               case p.BUILDING_NAME when null then null else ' '+p.BUILDING_NAME end
               , case p.FLOOR_NO when null then null else ' #'+p.FLOOR_NO end
               , case p.UNIT_NO when null then null else '-'+p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case p.POSTAL_CODE
                  when null then null
                  else ', '+p.POSTAL_CODE end
              ) AS BUSINESS_NAME ,dc.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission dds on dds.CYCLE_ID = dc.ID and dds.STATUS not in ('DS002','DS012')
                join premises p on dc.HCI_CODE =p.HCI_CODE and  p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dc.HCI_CODE)
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_efo_cycle_stage defocs on defocs.SUBMISSION_ID=dds.ID
                left join ds_iui_cycle_stage dics on dics.SUBMISSION_ID=dds.ID
                left join ds_iui_donor did on did.IUI_CYCLE_STAGE_ID = dics.ID
                left join ds_donor_sample did_donor on did_donor.ID=did.DONOR_SAMPLE_ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transfer_stage dets on dets.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where dc.CYCLE_TYPE in ('DSCL_009','DSCL_010','DSCL_011') and dc.HCI_CODE not in (select ar_cen.HCI_CODE from ds_center ar_cen where ar_cen.CENTER_TYPE ='ART')
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patient_id_types??> AND  ${patient_id_types}</#if>
                <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>

                <#if husbandName??> AND charindex(:husbandName, dh.NAME) >0 </#if>
                <#if husband_id_types??> AND  ${husband_id_types}</#if>
                <#if husbandIdNumber??> AND  :husbandIdNumber = dh.ID_NUMBER</#if>

                <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
                <#if cycleStagesStatus??> AND  :cycleStagesStatus = dc.STATUS </#if>
                <#if cycleStagesFinalStatus??> AND  :cycleStagesFinalStatus = 'DS003' and dc.STATUS in ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') </#if>
                <#if cycleStagesDateFrom??> AND ( dics.START_DATE >= convert(date,:cycleStagesDateFrom) or defocs.START_DATE >= convert(date,:cycleStagesDateFrom))</#if>
                <#if cycleStagesDateTo??> AND (  dics.START_DATE <= convert(datetime,:cycleStagesDateTo) or defocs.START_DATE <= convert(datetime,:cycleStagesDateTo))</#if>
                <#if arOrIui??> AND :arOrIui = dc.CYCLE_TYPE </#if>

                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  (charindex(:donorName, did_donor.DONOR_NAME) >0)</#if>
                <#if donorIdNumber??> AND  ( :donorIdNumber = did_donor.ID_NUMBER)</#if>
                <#if donor_id_types_ar??> AND (  ${donor_id_types_iui})</#if>
                <#if donorUsedYes??> AND :donorUsedYes = 1 and dds.ID in ( select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if donorUsedNo??> AND :donorUsedNo = 0 and dds.ID not in ( select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if FROM_DONOR??> AND  (:FROM_DONOR = dfs.IS_FROM_DONOR or :FROM_DONOR = dfs.IS_FROM_DONOR_TISSUE ) </#if>
                <#if FROM_HUSBAND??> AND  (:FROM_HUSBAND = dfs.IS_FROM_HUSBAND or :FROM_HUSBAND = dfs.IS_FROM_HUSBAND_TISSUE)</#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dets.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dets.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dets.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dets.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(datetime,:deliveryDateTo)</#if>
                <#if patientArtYes??> AND :patientArtYes = 1 AND 'ATSACF002' = datss.ART_CO_FUNDING or 'ATSACF003' = datss.ART_CO_FUNDING </#if>
                <#if patientArtNo??> AND :patientArtNo = 1 AND 'ATSACF001' = datss.ART_CO_FUNDING </#if>
                <#if patientIuiYes??> AND :patientIuiYes = 1 AND 'PICF002' = ditss.IUI_CO_FUNDING </#if>
                <#if patientIuiNo??> AND :patientIuiNo = 1 AND 'PICF001' = ditss.IUI_CO_FUNDING </#if>
                <#if patientPgtYes??> AND :patientPgtYes = 1 and 1 = dps.IS_PGT_CONFUNDING </#if>
                <#if patientPgtNo??> AND :patientPgtNo = 1 and 0 = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(datetime,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredOocyte??> AND  :transferredOocyte <= dtios.OOCYTE_NUM </#if>
                <#if transferredEmbryo??> AND  :transferredEmbryo <= dtios.EMBRYO_NUM </#if>
                <#if transferredSperm??> AND  :transferredSperm <= dtios.SPERM_VIALS_NUM </#if>
                <#if transferredInFrom??> AND TRANSFER_TYPE ='in' AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND TRANSFER_TYPE ='out' AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(datetime,:transferDateTo)</#if>
                <#if pgtNo??> AND :pgtNo = 1 AND dpi.PATIENT_CODE not in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtYes??> AND :pgtYes = 1 AND dpi.PATIENT_CODE  in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>
                UNION ALL
                SELECT dc.ID,dpi.PATIENT_CODE patient_code,
                case dc.CYCLE_TYPE
                when 'DSCL_009' then 'IUI'
                when 'DSCL_010' then 'EFO'
                when 'DSCL_011' then '-'
                else '-' end
                as DS_TYPE ,null TREATMENT_FRESH_NATURAL ,null TREATMENT_FRESH_STIMULATED ,null TREATMENT_FROZEN_EMBRYO ,null TREATMENT_FROZEN_OOCYTE ,dc.HCI_CODE,
                CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS BUSINESS_NAME ,dc.CREATED_DT ,dc.STATUS
                FROM ds_cycle dc
                join ds_patient_information dpi on dpi.PATIENT_CODE =dc.PATIENT_CODE
                join ds_data_submission dds on dds.CYCLE_ID = dc.ID and dds.STATUS not in ('DS002','DS012')
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dcen.CENTER_TYPE = 'ART'
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_efo_cycle_stage defocs on defocs.SUBMISSION_ID=dds.ID
                left join ds_iui_cycle_stage dics on dics.SUBMISSION_ID=dds.ID
                left join ds_iui_donor did on did.IUI_CYCLE_STAGE_ID = dics.ID
                left join ds_donor_sample did_donor on did_donor.ID=did.DONOR_SAMPLE_ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transfer_stage dets on dets.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where dc.CYCLE_TYPE in ('DSCL_009','DSCL_010','DSCL_011')
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patient_id_types??> AND  ${patient_id_types}</#if>
                <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>

                <#if husbandName??> AND charindex(:husbandName, dh.NAME) >0 </#if>
                <#if husband_id_types??> AND  ${husband_id_types}</#if>
                <#if husbandIdNumber??> AND  :husbandIdNumber = dh.ID_NUMBER</#if>

                <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
                <#if cycleStagesStatus??> AND  :cycleStagesStatus = dc.STATUS </#if>
                <#if cycleStagesFinalStatus??> AND  :cycleStagesFinalStatus = 'DS003' and dc.STATUS in ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') </#if>
                <#if cycleStagesDateFrom??> AND ( dics.START_DATE >= convert(date,:cycleStagesDateFrom) or defocs.START_DATE >= convert(date,:cycleStagesDateFrom))</#if>
                <#if cycleStagesDateTo??> AND (  dics.START_DATE <= convert(datetime,:cycleStagesDateTo) or defocs.START_DATE <= convert(datetime,:cycleStagesDateTo))</#if>
                <#if arOrIui??> AND :arOrIui = dc.CYCLE_TYPE </#if>

                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  ( charindex(:donorName, did_donor.DONOR_NAME) >0)</#if>
                <#if donorIdNumber??> AND  (:donorIdNumber = did_donor.ID_NUMBER)</#if>
                <#if donor_id_types_ar??> AND ( ${donor_id_types_iui})</#if>
                <#if donorUsedYes??> AND :donorUsedYes = 1 and dds.ID in ( select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if donorUsedNo??> AND :donorUsedNo = 0 and dds.ID not in ( select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if FROM_DONOR??> AND  (:FROM_DONOR = dfs.IS_FROM_DONOR or :FROM_DONOR = dfs.IS_FROM_DONOR_TISSUE ) </#if>
                <#if FROM_HUSBAND??> AND  (:FROM_HUSBAND = dfs.IS_FROM_HUSBAND or :FROM_HUSBAND = dfs.IS_FROM_HUSBAND_TISSUE)</#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dets.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dets.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dets.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dets.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(datetime,:deliveryDateTo)</#if>
                <#if patientArtYes??> AND :patientArtYes = 1 AND 'ATSACF002' = datss.ART_CO_FUNDING or 'ATSACF003' = datss.ART_CO_FUNDING </#if>
                <#if patientArtNo??> AND :patientArtNo = 1 AND 'ATSACF001' = datss.ART_CO_FUNDING </#if>
                <#if patientIuiYes??> AND :patientIuiYes = 1 AND 'PICF002' = ditss.IUI_CO_FUNDING </#if>
                <#if patientIuiNo??> AND :patientIuiNo = 1 AND 'PICF001' = ditss.IUI_CO_FUNDING </#if>
                <#if patientPgtYes??> AND :patientPgtYes = 1 and 1 = dps.IS_PGT_CONFUNDING </#if>
                <#if patientPgtNo??> AND :patientPgtNo = 1 and 0 = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(datetime,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredOocyte??> AND  :transferredOocyte <= dtios.OOCYTE_NUM </#if>
                <#if transferredEmbryo??> AND  :transferredEmbryo <= dtios.EMBRYO_NUM </#if>
                <#if transferredSperm??> AND  :transferredSperm <= dtios.SPERM_VIALS_NUM </#if>
                <#if transferredInFrom??> AND TRANSFER_TYPE ='in' AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND TRANSFER_TYPE ='out' AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(datetime,:transferDateTo)</#if>
                <#if pgtNo??> AND :pgtNo = 1 AND dpi.PATIENT_CODE not in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtYes??> AND :pgtYes = 1 AND dpi.PATIENT_CODE  in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>

            ) ajax
            where 1=1
            <#if patientCode??> AND  :patientCode = ajax.patient_code</#if>

        ]]>
    </sql>

    <sql key = "advancedSearchPatientByAssistedReproduction" remarks="Advanced Search patient by Assisted Reproduction">
        <![CDATA[
           SELECT distinct dpi.ID, dpi.NAME, dpi.ID_TYPE, dpi.ID_NUMBER, dpi.DATE_OF_BIRTH, dpi.NATIONALITY,dc2.PATIENT_CODE CD_PATIENT_CODE,dpi.PATIENT_CODE
                FROM ds_patient_information dpi
                join ds_data_submission dds on (dds.ID = dpi.SUBMISSION_ID or dds.CYCLE_ID in(select dcp.ID from ds_cycle dcp where dcp.PATIENT_CODE = dpi.PATIENT_CODE)) AND dds.STATUS in ('DS001', 'DS011')
                JOIN ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART'
                left join ds_cycle dc2 on dc2.PATIENT_CODE = dpi.PATIENT_CODE
                left join ds_husband dh on dpi.ID= dh.PATIENT_ID
                left join ds_ar_cycle_stage dacs on dacs.SUBMISSION_ID=dds.ID
                left join ds_end_cycle_stage decs on decs.SUBMISSION_ID=dds.ID
                left join ds_ar_donor dad on dad.CYCLE_STAGE_ID = dacs.ID
                left join ds_efo_cycle_stage defocs on defocs.SUBMISSION_ID=dds.ID
                left join ds_iui_cycle_stage dics on dics.SUBMISSION_ID=dds.ID
                left join ds_iui_donor did on did.IUI_CYCLE_STAGE_ID = dics.ID
                left join ds_donor_sample dad_donor on dad_donor.ID=dad.DONOR_SAMPLE_ID
                left join ds_donor_sample did_donor on did_donor.ID=did.DONOR_SAMPLE_ID
                left join ds_fertilisation_stage dfs on dfs.SUBMISSION_ID=dds.ID
                left join ds_embryo_transfer_stage dets on dets.SUBMISSION_ID=dds.ID
                left join ds_embryo_transferred_outcome_stage detos on detos.SUBMISSION_ID=dds.ID
                left join ds_pregnancy_outcome_stage dpos on dpos.SUBMISSION_ID=dds.ID
                left join ds_ar_treatment_subsidies_stage datss on datss.SUBMISSION_ID=dds.ID
                left join ds_pgt_stage dps on dps.SUBMISSION_ID=dds.ID
                left join ds_iui_treatment_subsidies_stage ditss on ditss.SUBMISSION_ID=dds.ID
                left join ds_disposal_stage ddiss on ddiss.SUBMISSION_ID=dds.ID
                left join ds_transfer_in_out_stage dtios on dtios.SUBMISSION_ID=dds.ID
                where 1=1
                <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
                <#if patient_id_types??> AND  ${patient_id_types}</#if>
                <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
                <#if patientAgeDateFrom??> AND dpi.DATE_OF_BIRTH <= convert(date,:patientAgeDateFrom)</#if>
                <#if patientAgeDateTo??> AND dpi.DATE_OF_BIRTH >= convert(date,:patientAgeDateTo)</#if>
                <#if submissionId??> AND  :submissionId = dds.SUBMISSION_NO</#if>
                <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
                <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>

                <#if husbandName??> AND charindex(:husbandName, dh.NAME) >0 </#if>
                <#if husband_id_types??> AND  ${husband_id_types}</#if>
                <#if husbandIdNumber??> AND  :husbandIdNumber = dh.ID_NUMBER</#if>

                <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
                <#if embryologist??> AND  charindex(:embryologist, dacs.EMBRYOLOGIST) >0</#if>
                <#if arPractitioner??> AND  charindex(:arPractitioner, dacs.PRACTITIONER) >0</#if>

                <#if cycleStagesStatus??> AND  :cycleStagesStatus = dc.STATUS </#if>
                <#if cycleStagesFinalStatus??> AND  :cycleStagesFinalStatus = 'DS003' and dc.STATUS in ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') </#if>
                <#if indicationArCycleList??> AND  ${indicationArCycleList}</#if>
                <#if cycleStagesDateFrom??> AND (dacs.START_DATE >= convert(date,:cycleStagesDateFrom) or dics.START_DATE >= convert(date,:cycleStagesDateFrom) or defocs.START_DATE >= convert(date,:cycleStagesDateFrom))</#if>
                <#if cycleStagesDateTo??> AND ( dacs.START_DATE <= convert(datetime,:cycleStagesDateTo) or dics.START_DATE <= convert(datetime,:cycleStagesDateTo) or defocs.START_DATE <= convert(datetime,:cycleStagesDateTo))</#if>
                <#if arOrIui??> AND :arOrIui = dc.CYCLE_TYPE </#if>
                <#if ivm??> AND  :ivm = dacs.IN_VITRO_MATURATION </#if>
                <#if cart_fcn??> AND  :cart_fcn = dacs.TREATMENT_FRESH_NATURAL </#if>
                <#if cart_fcs??> AND  :cart_fcs = dacs.TREATMENT_FRESH_STIMULATED </#if>
                <#if cart_foc??> AND  :cart_foc = dacs.TREATMENT_FROZEN_OOCYTE </#if>
                <#if cart_foe??> AND  :cart_foe = dacs.TREATMENT_FROZEN_EMBRYO </#if>
                <#if freshCycleNumFrom??> AND  :freshCycleNumFrom <= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID  and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE )  </#if>
                <#if freshCycleNumTo??> AND  :freshCycleNumTo >= ( select COUNT(dacs1.ID) From ds_ar_cycle_stage dacs1 join ds_data_submission dds2 on dds2.ID = dacs1.SUBMISSION_ID and dds2.STATUS not in ('DS002','DS012') join ds_cycle dc1 on dc1.ID =dds2.CYCLE_ID and dc1.STATUS in  ('DS003','DS004','DS005','DS006','DS007','DS008','DS009') where  (dacs1.TREATMENT_FRESH_NATURAL = 1 or dacs1.TREATMENT_FRESH_STIMULATED = 1) and dc1.PATIENT_CODE = dpi.PATIENT_CODE ) </#if>

                <#if abandonedCycle??> AND  :abandonedCycle = decs.IS_CYCLE_ABANDONED </#if>

                <#if donorName??> AND  (charindex(:donorName, dad_donor.DONOR_NAME) >0 or charindex(:donorName, did_donor.DONOR_NAME) >0)</#if>
                <#if donorIdNumber??> AND  (:donorIdNumber = dad_donor.ID_NUMBER or :donorIdNumber = did_donor.ID_NUMBER)</#if>
                <#if donor_id_types_ar??> AND (  ${donor_id_types_ar} OR ${donor_id_types_iui})</#if>
                <#if donorUsedYes??> AND :donorUsedYes = 1 and dds.ID in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID UNION ALL select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if donorUsedNo??> AND :donorUsedNo = 0 and dds.ID not in (select ch_dacs.SUBMISSION_ID from ds_ar_donor ch_dad join ds_ar_cycle_stage ch_dacs on ch_dacs.ID= ch_dad.CYCLE_STAGE_ID UNION ALL select ch_dics.SUBMISSION_ID from ds_iui_donor ch_did join ds_iui_cycle_stage ch_dics on ch_dics.ID= ch_did.IUI_CYCLE_STAGE_ID) </#if>
                <#if FROM_DONOR??> AND  (:FROM_DONOR = dfs.IS_FROM_DONOR or :FROM_DONOR = dfs.IS_FROM_DONOR_TISSUE ) </#if>
                <#if FROM_HUSBAND??> AND  (:FROM_HUSBAND = dfs.IS_FROM_HUSBAND or :FROM_HUSBAND = dfs.IS_FROM_HUSBAND_TISSUE)</#if>
                <#if gift??> AND  :gift = dfs.IS_GIFT_USED </#if>
                <#if icsi??> AND  :icsi = dfs.IS_ICSI_USED </#if>
                <#if zift??> AND  :zift = dfs.IS_ZIFT_USED </#if>
                <#if ivf??> AND  :ivf = dfs.IS_IVF_USED </#if>
                <#if embTransNums??> AND dets.TRANSFER_NUM in( :embTransNums)</#if>
                <#if ageEmbryosNums??> AND (dets.FIRST_EMBRYO_AGE in( :ageEmbryosNums) or dets.SECOND_EMBRYO_AGE in( :ageEmbryosNums) or dets.THIRD_EMBRYO_AGE in( :ageEmbryosNums)) </#if>
                <#if outcomeEmbryoTransferreds??> AND detos.TRANSFERED_OUTCOME in( :outcomeEmbryoTransferreds) </#if>
                <#if birthEventsTotalList??> AND (dpos.MALE_LIVE_BIRTH_NUM+dpos.FEMALE_LIVE_BIRTH_NUM) in( :birthEventsTotalList) </#if>
                <#if deliveryDateFrom??> AND dpos.DELIVERY_DATE >= convert(date,:deliveryDateFrom)</#if>
                <#if deliveryDateTo??> AND dpos.DELIVERY_DATE <= convert(datetime,:deliveryDateTo)</#if>
                <#if patientArtYes??> AND :patientArtYes = 1 AND 'ATSACF002' = datss.ART_CO_FUNDING or 'ATSACF003' = datss.ART_CO_FUNDING </#if>
                <#if patientArtNo??> AND :patientArtNo = 1 AND 'ATSACF001' = datss.ART_CO_FUNDING </#if>
                <#if patientIuiYes??> AND :patientIuiYes = 1 AND 'PICF002' = ditss.IUI_CO_FUNDING </#if>
                <#if patientIuiNo??> AND :patientIuiNo = 1 AND 'PICF001' = ditss.IUI_CO_FUNDING </#if>
                <#if patientPgtYes??> AND :patientPgtYes = 1 and 1 = dps.IS_PGT_CONFUNDING </#if>
                <#if patientPgtNo??> AND :patientPgtNo = 1 and 0 = dps.IS_PGT_CONFUNDING </#if>
                <#if disposalTypeList??> AND ddiss.DISPOSED_TYPE in( :disposalTypeList)</#if>
                <#if disposedTotalNumber??> AND (ddiss.IMMATURE+ddiss.ABNORMALLY_FERTILISED+ddiss.UNFERTILISED+ddiss.ATRETIC+ddiss.DAMAGED+ddiss.LYSED_OR_DEGENERATED+ddiss.UNHEALTHY_NUM+ddiss.OTHER_DISCARDED_NUM) = :disposedTotalNumber</#if>
                <#if disposalDateFrom??> AND ddiss.CREATED_DT >= convert(date,:disposalDateFrom)</#if>
                <#if disposalDateTo??> AND ddiss.CREATED_DT <= convert(datetime,:disposalDateTo)</#if>
                <#if transferInOrOut??> AND  :transferInOrOut = dtios.TRANSFER_TYPE </#if>
                <#if transferredOocyte??> AND  :transferredOocyte <= dtios.OOCYTE_NUM </#if>
                <#if transferredEmbryo??> AND  :transferredEmbryo <= dtios.EMBRYO_NUM </#if>
                <#if transferredSperm??> AND  :transferredSperm <= dtios.SPERM_VIALS_NUM </#if>
                <#if transferredInFrom??> AND TRANSFER_TYPE ='in' AND  charindex(:transferredInFrom, dtios.TRANS_IN_FROM_HCI_CODE) >0</#if>
                <#if transferOutTo??> AND TRANSFER_TYPE ='out' AND  charindex(:transferOutTo, dtios.TRANS_OUT_TO_HCI_CODE) >0</#if>
                <#if transferDateFrom??> AND dtios.CREATED_DT >= convert(date,:transferDateFrom)</#if>
                <#if transferDateTo??> AND dtios.CREATED_DT <= convert(datetime,:transferDateTo)</#if>
                <#if pgtNo??> AND :pgtNo = 1 AND dpi.PATIENT_CODE not in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtYes??> AND :pgtYes = 1 AND dpi.PATIENT_CODE  in (SELECT distinct dpiNN.PATIENT_CODE FROM ds_patient_information dpiNN  join ds_cycle dcNN on dcNN.PATIENT_CODE = dpiNN.PATIENT_CODE join ds_data_submission ddsNN on ddsNN.CYCLE_STAGE ='AR_STG005' and ddsNN.CYCLE_ID =dcNN.ID ) </#if>
                <#if pgtMCom??> AND  dps.IS_PGT_M_WU_COM = :pgtMCom </#if>
                <#if pgtMRare??> AND  dps.IS_PGT_M_WU_RARE = :pgtMRare </#if>
                <#if pgtMEbt??> AND  dps.IS_PGT_M_EBT = :pgtMEbt </#if>
                <#if pgtSr??> AND  dps.IS_PGT_SR = :pgtSr </#if>
                <#if pgtA??> AND  dps.IS_PGT_A = :pgtA </#if>
                <#if ptt??> AND  dps.IS_PTT = :ptt </#if>
                <#if pgtOthers??> AND  dps.IS_OTHER_PGT = :pgtOthers </#if>
                <#if PGT_M_DSLD??> AND  dps.IS_PGT_M_DSLD = :PGT_M_DSLD </#if>



        ]]>
    </sql>

    <sql key = "searchTransactionHistoryByAssistedReproduction" remarks="search Transaction History">
        <![CDATA[
        SELECT distinct tt.* from (
        SELECT  dds.ID ,
            CONCAT(case lp.BUSINESS_NAME when null then '-, ' when '' then '-, ' else lp.BUSINESS_NAME + ', ' end ,
                  case p.BLK_NO when null then null else ''+p.BLK_NO end ,
               case p.STREET_NAME when null then null else ' '+p.STREET_NAME end ,
               case p.BUILDING_NAME when null then null else ' '+p.BUILDING_NAME end
               , case p.FLOOR_NO when null then null else ' #'+p.FLOOR_NO end
               , case p.UNIT_NO when null then null else '-'+p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case p.POSTAL_CODE
                  when null then null
                  else ', '+p.POSTAL_CODE end
              ) AS BUSINESS_NAME,
            dds.SUBMISSION_NO ,dds.SUBMIT_DT ,dds.CYCLE_STAGE ,dds.CYCLE_ID ,
                ( select count(dds2.CYCLE_ID) From ds_data_submission dds2 where dds2.CYCLE_ID= dc.ID and dds2.STATUS not in ('DS002','DS012'))  cycle_no ,
                daic.FROZEN_OOCY_NUM, daic.THAWED_OOCY_NUM, daic.FRESH_OOCY_NUM, daic.FROZEN_EMBR_NUM, daic.THAWED_EMBR_NUM, daic.FRESH_EMBR_NUM, daic.FROZEN_SPERM_NUM
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART' and dc.HCI_CODE not in (select ar_cen.HCI_CODE from ds_center ar_cen where ar_cen.CENTER_TYPE ='ART')
                join premises p on dc.HCI_CODE =p.HCI_CODE and  p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dc.HCI_CODE)
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
                left join ds_data_submission dds3 on dds3.CYCLE_ID= dc.ID and dds3.STATUS not in ('DS002','DS012')
                left join ds_ar_inventory_change daic on daic.SUBMISSION_ID = dds.ID

                where dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
            <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
            <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>
            <#if transfers??> AND :transfers = 1 AND dc.id in (SELECT dcIn.ID FROM ds_cycle dcIn join ds_data_submission ddsIn on ddsIn.CYCLE_STAGE ='AR_STG016' and ddsIn.CYCLE_ID =dcIn.ID )</#if>
            <#if transfersNotIn??> AND :transfersNotIn = 1 AND dc.id not in (SELECT dcIn.ID FROM ds_cycle dcIn join ds_data_submission ddsIn on ddsIn.CYCLE_STAGE ='AR_STG016' and ddsIn.CYCLE_ID =dcIn.ID )</#if>

            <#if patientCode??> AND  dc.PATIENT_CODE = :patientCode </#if>
            UNION ALL
            SELECT  dds.ID ,
            CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS BUSINESS_NAME,
            dds.SUBMISSION_NO ,dds.SUBMIT_DT ,dds.CYCLE_STAGE ,dds.CYCLE_ID ,
                ( select count(dds2.CYCLE_ID) From ds_data_submission dds2 where dds2.CYCLE_ID= dc.ID and dds2.STATUS not in ('DS002','DS012'))  cycle_no ,
                daic.FROZEN_OOCY_NUM, daic.THAWED_OOCY_NUM, daic.FRESH_OOCY_NUM, daic.FROZEN_EMBR_NUM, daic.THAWED_EMBR_NUM, daic.FRESH_EMBR_NUM, daic.FROZEN_SPERM_NUM
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'ART'
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dcen.CENTER_TYPE = 'ART'
                left join ds_data_submission dds3 on dds3.CYCLE_ID= dc.ID and dds3.STATUS not in ('DS002','DS012')
                left join ds_ar_inventory_change daic on daic.SUBMISSION_ID = dds.ID

                where dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter</#if>
            <#if submission_start_date??> AND dds.SUBMIT_DT >= convert(date,:submission_start_date)</#if>
            <#if submission_to_date??> AND dds.SUBMIT_DT <= convert(datetime,:submission_to_date)</#if>
            <#if transfers??> AND :transfers = 1 AND dc.id in (SELECT dcIn.ID FROM ds_cycle dcIn join ds_data_submission ddsIn on ddsIn.CYCLE_STAGE ='AR_STG016' and ddsIn.CYCLE_ID =dcIn.ID )</#if>
            <#if transfersNotIn??> AND :transfersNotIn = 1 AND dc.id not in (SELECT dcIn.ID FROM ds_cycle dcIn join ds_data_submission ddsIn on ddsIn.CYCLE_STAGE ='AR_STG016' and ddsIn.CYCLE_ID =dcIn.ID )</#if>
            
            <#if patientCode??> AND  dc.PATIENT_CODE = :patientCode </#if>
        ) tt
        where 1=1
          <#if cycleNo??> AND  tt.cycle_no = :cycleNo </#if>



         ]]>
    </sql>

    <sql key = "searchCycleStageByPatientCode" remarks="search Cycle Stage">
        <![CDATA[
            SELECT distinct dc.ID,null as cycle_no,dc.CREATED_DT ,
            (case dc.CYCLE_TYPE
            when 'DSCL_008' then 'AR'
            when 'DSCL_009' then 'IUI'
            when 'DSCL_010' then 'EFO'
             else  '-' end) as CYCLE_TYPE
            , dds.CYCLE_STAGE ,dc.STATUS
            from ds_cycle dc
            join ds_data_submission dds on  dds.SUBMISSION_NO = (select MAX(dds1.SUBMISSION_NO) from ds_data_submission dds1 where dds1.CYCLE_ID =dc.ID and dds1.STATUS not in ('DS002'))
             where dc.CYCLE_TYPE in ('DSCL_008','DSCL_009','DSCL_010') and dds.STATUS not in ('DS002')
            <#if patientCode??> AND  dc.PATIENT_CODE = :patientCode </#if>

         ]]>
    </sql>

    <sql key = "searchNonCycleStageByPatientCode" remarks="search Cycle Stage">
        <![CDATA[
            SELECT distinct dc.ID,null as cycle_no,dc.CREATED_DT ,'-' as CYCLE_TYPE, dds.CYCLE_STAGE ,dc.STATUS
            from ds_cycle dc
            join ds_data_submission dds on  dds.SUBMISSION_NO = (select MAX(dds1.SUBMISSION_NO) from ds_data_submission dds1 where dds1.CYCLE_ID =dc.ID and dds1.STATUS not in ('DS002'))
             where dc.CYCLE_TYPE ='DSCL_011' and dds.STATUS not in ('DS002')
            <#if patientCode??> AND  dc.PATIENT_CODE = :patientCode </#if>

         ]]>
    </sql>

    <sql key = "searchDonorSampleByAssistedReproduction" remarks="search Donor Sample">
        <![CDATA[
        SELECT distinct tt.* from (
        SELECT  dds2.ID ,dds.SUBMISSION_NO,
            CONCAT(case lp.BUSINESS_NAME when null then '-, ' when '' then '-, ' else lp.BUSINESS_NAME + ', ' end ,
                  case p.BLK_NO when null then null else ''+p.BLK_NO end ,
               case p.STREET_NAME when null then null else ' '+p.STREET_NAME end ,
               case p.BUILDING_NAME when null then null else ' '+p.BUILDING_NAME end
               , case p.FLOOR_NO when null then null else ' #'+p.FLOOR_NO end
               , case p.UNIT_NO when null then null else '-'+p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case p.POSTAL_CODE
                  when null then null
                  else ', '+p.POSTAL_CODE end
              ) AS BUSINESS_NAME,
               case dds2.ID_TYPE when 'AR_IT_005' then dds2.ID_NUMBER else dds2.DONOR_SAMPLE_CODE end as DONOR_SAMPLE_CODE ,dds2.SAMPLE_TYPE ,
            case dds2.SAMPLE_FROM_HCI_CODE when 'AR_SC_001' then CONCAT('Others - ',dds2.SAMPLE_FROM_OTHERS)
            else
           		CONCAT(case dds2lp.BUSINESS_NAME
                  when null then '-, '
                  when '' then '-, '
                  else dds2lp.BUSINESS_NAME + ', ' end ,
                  case dds2p.BLK_NO
                  when null then null
                  else ''+dds2p.BLK_NO end ,
               case dds2p.STREET_NAME
                  when null then null
                  else ' '+dds2p.STREET_NAME end
               , case dds2p.BUILDING_NAME
                  when null then null
                  else ' '+dds2p.BUILDING_NAME end
               , case dds2p.FLOOR_NO
                  when null then null
                  else ' #'+dds2p.FLOOR_NO end
               , case dds2p.UNIT_NO
                  when null then null
                  else '-'+dds2p.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM premises_operational_unit pou
				        WHERE pou.PREMISES_ID =dds2p.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case dds2p.POSTAL_CODE
                  when null then null
                  else ', '+dds2p.POSTAL_CODE end
              ) end
             AS SAMPLE_FROM_HCI_CODE ,
           		dds2.DONOR_NAME , dds2.LIVE_BIRTH_NUM age_no
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.HCI_CODE not in (select ar_cen.HCI_CODE from ds_center ar_cen where ar_cen.CENTER_TYPE ='ART')
                join premises p on dc.HCI_CODE =p.HCI_CODE and  p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dc.HCI_CODE)
                JOIN lic_premises lp on lp.PREMISES_ID =p.ID
				join ds_donor_sample dds2 on dds2.SUBMISSION_ID = dds.ID
				left join premises dds2p on dds2.SAMPLE_FROM_HCI_CODE =dds2p.HCI_CODE and  dds2p.CREATED_DT =(select max(CREATED_DT) from premises where HCI_CODE =dds2.SAMPLE_FROM_HCI_CODE)
                left JOIN lic_premises dds2lp on dds2lp.PREMISES_ID =dds2p.ID

                where dc.CYCLE_TYPE ='DSCL_003' and dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter </#if>
            <#if donorSampleCode??> AND  charindex(:donorSampleCode, (case dds2.ID_TYPE when 'AR_IT_005' then dds2.ID_NUMBER else dds2.DONOR_SAMPLE_CODE end)) >0</#if>
            <#if othersDonorSampleCode??> AND  charindex(:othersDonorSampleCode, dds2.SAMPLE_FROM_OTHERS) >0</#if>
            <#if sampleType??> AND  charindex(:sampleType, dds2.SAMPLE_TYPE) >0</#if>
            <#if sampleHciCode??> AND dds2.SAMPLE_FROM_HCI_CODE = :sampleHciCode </#if>
            <#if donorIdType??> AND  charindex(:donorIdType, dds2.ID_TYPE) >0</#if>
            <#if donorIdNumber??> AND  charindex(:donorIdNumber, dds2.ID_NUMBER) >0</#if>
            <#if birthEventsTotalList??> AND dds2.LIVE_BIRTH_NUM  in( :birthEventsTotalList) </#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>


            UNION ALL
            SELECT  dds2.ID ,dds.SUBMISSION_NO,
            CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS BUSINESS_NAME,
              case dds2.ID_TYPE when 'AR_IT_005' then dds2.ID_NUMBER else dds2.DONOR_SAMPLE_CODE end as DONOR_SAMPLE_CODE ,dds2.SAMPLE_TYPE ,
            case dds2.SAMPLE_FROM_HCI_CODE when 'AR_SC_001' then CONCAT('Others - ',dds2.SAMPLE_FROM_OTHERS)
            else
           		CONCAT(case dcen2.CENTER_NAME
                  when null then '-, '
                  when '' then '-, '
                  else dcen2.CENTER_NAME + ', ' end ,
                  case dcen2.BLK_NO
                  when null then null
                  else ''+dcen2.BLK_NO end ,
               case dcen2.STREET_NAME
                  when null then null
                  else ' '+dcen2.STREET_NAME end
               , case dcen2.BUILDING_NAME
                  when null then null
                  else ' '+dcen2.BUILDING_NAME end
               , case dcen2.FLOOR_NO
                  when null then null
                  else ' #'+dcen2.FLOOR_NO end
               , case dcen2.UNIT_NO
                  when null then null
                  else '-'+dcen2.UNIT_NO end
               ,case dcen2.POSTAL_CODE
                  when null then null
                  else ', '+dcen2.POSTAL_CODE end
              ) end
             AS SAMPLE_FROM_HCI_CODE ,
           		dds2.DONOR_NAME ,dds2.LIVE_BIRTH_NUM   age_no
                FROM ds_data_submission dds
                join ds_cycle dc on dc.ID =dds.CYCLE_ID
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dcen.CENTER_TYPE ='ART'
				join ds_donor_sample dds2 on dds2.SUBMISSION_ID = dds.ID
				left join ds_center dcen2  on dds2.SAMPLE_FROM_HCI_CODE =dcen2.HCI_CODE and dcen2.CENTER_TYPE ='ART'
                where dc.CYCLE_TYPE ='DSCL_003' and dds.STATUS not in ('DS002','DS012')
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter </#if>
            <#if donorSampleCode??> AND  charindex(:donorSampleCode, (case dds2.ID_TYPE when 'AR_IT_005' then dds2.ID_NUMBER else dds2.DONOR_SAMPLE_CODE end)) >0</#if>
            <#if othersDonorSampleCode??> AND  charindex(:othersDonorSampleCode, dds2.SAMPLE_FROM_OTHERS) >0</#if>
            <#if sampleType??> AND  charindex(:sampleType, dds2.SAMPLE_TYPE) >0</#if>
            <#if sampleHciCode??> AND dds2.SAMPLE_FROM_HCI_CODE = :sampleHciCode </#if>
            <#if donorIdType??> AND  charindex(:donorIdType, dds2.ID_TYPE) >0</#if>
            <#if donorIdNumber??> AND  charindex(:donorIdNumber, dds2.ID_NUMBER) >0</#if>
            <#if birthEventsTotalList??> AND (select count(ddsa.DONOR_SAMPLE_ID) From ds_donor_sample_age ddsa where ddsa.SAMPLE_KEY= dds2.SAMPLE_KEY and ddsa.STATUS !='DAS_A') in( :birthEventsTotalList) </#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>
          )tt
         ]]>
    </sql>

    <sql key = "searchLaboratoryDevelopTest" remarks="search Laboratory Develop Test">
        <![CDATA[
            select distinct * from (
            SELECT  ldt.ID,null SUBMISSION_ID,
                   CONCAT(case Prem.HCI_NAME
                  when null then null
                  else ', '+Prem.HCI_NAME end ,
                  case Prem.BLK_NO
                  when null then null
                  else ''+Prem.BLK_NO end ,
               case Prem.STREET_NAME
                  when null then null
                  else ' '+Prem.STREET_NAME end
               , case Prem.BUILDING_NAME
                  when null then null
                  else ' '+Prem.BUILDING_NAME end
               , case Prem.FLOOR_NO
                  when null then null
                  else ' #'+Prem.FLOOR_NO end
               , case Prem.UNIT_NO
                  when null then null
                  else '-'+Prem.UNIT_NO end
               ,
               SUBSTRING ((
		        SELECT ', #' + pou.FLOOR_NO +'-'+pou.UNIT_NO
				        FROM hcsal.dbo.premises_operational_unit pou
				        WHERE pou.PREMISES_ID =Prem.ID
				        ORDER BY SEQ_NUM ASC
				        FOR XML path('')
		    ), 1, 1000)
               ,case Prem.POSTAL_CODE
                  when null then null
                  else ', '+Prem.POSTAL_CODE end
              )  LDT_NAME, ldt.LDT_TEST_NAME, ldt.INTENDED_PURPOSE, ldt.LDT_DATE, ldt.RESPONSE_PERSON, ldt.DESIGNATION,
              case ldt.TEST_STATUS
              when 1 then 'Active'
              when 0 then 'Inactive'
              else '' end TEST_STATUS
              , ldt.REMARKS ,ldt.LDT_NO
                FROM ds_laboratory_develop_test ldt
                join ds_data_submission dds on dds.ID = ldt.SUBMISSION_ID
                join ds_cycle dc on dc.ID=dds.CYCLE_ID
                join premises Prem on Prem.HCI_CODE = dc.HCI_CODE and dc.HCI_CODE not in (select ldt_cen.HCI_CODE from ds_center ldt_cen where ldt_cen.CENTER_TYPE = 'LDT')
                UNION ALL
              SELECT  ldt.ID,null SUBMISSION_ID,
                   CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) LDT_NAME, ldt.LDT_TEST_NAME, ldt.INTENDED_PURPOSE, ldt.LDT_DATE, ldt.RESPONSE_PERSON, ldt.DESIGNATION,
              case ldt.TEST_STATUS
              when 1 then 'Active'
              when 0 then 'Inactive'
              else '' end TEST_STATUS
              , ldt.REMARKS ,ldt.LDT_NO
                FROM ds_laboratory_develop_test ldt
                join ds_data_submission dds on dds.ID = ldt.SUBMISSION_ID
                join ds_cycle dc on dc.ID=dds.CYCLE_ID
                join ds_center dcen on dcen.HCI_CODE = dc.HCI_CODE and dcen.CENTER_TYPE = 'LDT'
                ) T1
            where 1 = 1
            <#if ldtDateFrom??> AND T1.LDT_DATE >= convert(date,:ldtDateFrom)</#if>
            <#if ldtDateTo??> AND T1.LDT_DATE <= convert(datetime,:ldtDateTo)</#if>
            <#if laboratoryName??> AND  charindex(:laboratoryName, T1.LDT_NAME) >0</#if>
            <#if ldtTestName??> AND  charindex(:ldtTestName, T1.LDT_TEST_NAME) >0</#if>
            <#if responsePerson??> AND  charindex(:responsePerson, T1.RESPONSE_PERSON) >0</#if>
            <#if testStatus??> AND  T1.TEST_STATUS = :testStatus</#if>
         ]]>
    </sql>

    <sql key = "searchByTop" remarks="Search Termination of Pregnancy">
        <![CDATA[
            select distinct * from (
            SELECT dds.id, CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME ,dds.SUBMISSION_NO ,dtp.PATIENT_NAME ,dtp.PATIENT_ID_TYPE ,dtp.PATIENT_ID_NO ,dtp.PATIENT_BIRTHDAY ,dtt.DOCTOR_REGN_NO ,dtt.DOCTOR_NAME ,dds.SUBMIT_DT
                ,(SELECT  COUNT(dtpNew.PATIENT_ID_NO + dtpNew.PATIENT_ID_TYPE ) as num
                FROM  ds_top_patient dtpNew
                where dtpNew.PATIENT_ID_NO =dtp.PATIENT_ID_NO and dtpNew.PATIENT_ID_TYPE =dtp.PATIENT_ID_TYPE
                ) num
                FROM ds_data_submission dds
                join  ds_top_patient dtp on dds.ID =dtp.SUBMISSION_ID
                join ds_cycle dc on dds.CYCLE_ID =dc.ID
                left join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE  and dc.DS_TYPE =dcen.CENTER_TYPE
                left join ds_top_termination dtt  on dds.ID = dtt.SUBMISSION_ID

                where dds.SUBMIT_DT in (SELECT  MAX(ddsNew.SUBMIT_DT ) SUBMIT_DT
                FROM ds_data_submission ddsNew
                join  ds_top_patient dtpNew on ddsNew.ID =dtpNew.SUBMISSION_ID
                GROUP BY dtpNew.PATIENT_ID_NO ,dtpNew.PATIENT_ID_TYPE )
                ) T1
            where 1 = 1
            <#if patientIdType??> AND  charindex(:patientIdType, T1.PATIENT_ID_TYPE) >0</#if>
            <#if patientIdNo??> AND  charindex(:patientIdNo, T1.PATIENT_ID_NO) >0</#if>
            <#if submissionNo??> AND  charindex(:submissionNo, T1.SUBMISSION_NO) >0</#if>
            <#if patientName??> AND  charindex(:patientName, T1.PATIENT_NAME) >0</#if>
            <#if doctorRegnNo??> AND  charindex(:doctorRegnNo, T1.DOCTOR_REGN_NO) >0</#if>
            <#if birthDateFrom??> AND T1.PATIENT_BIRTHDAY >= convert(date,:birthDateFrom)</#if>
            <#if birthDateTo??> AND T1.PATIENT_BIRTHDAY <= convert(datetime,:birthDateTo)</#if>
            <#if submissionDateFrom??> AND T1.SUBMIT_DT >= convert(date,:submissionDateFrom)</#if>
            <#if submissionDateTo??> AND T1.SUBMIT_DT <= convert(datetime,:submissionDateTo)</#if>
         ]]>
    </sql>

    <sql key = "searchTopAjax" remarks="Search Termination of Pregnancy Ajax">
        <![CDATA[
            select distinct * from (
            SELECT dds.id, CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME ,dds.SUBMISSION_NO ,dtp.PATIENT_NAME ,dtp.PATIENT_ID_TYPE ,dtp.PATIENT_ID_NO ,dtp.PATIENT_BIRTHDAY ,dtt.DOCTOR_REGN_NO ,dtt.DOCTOR_NAME ,dds.SUBMIT_DT,null num
                FROM ds_data_submission dds
                join  ds_top_patient dtp on dds.ID =dtp.SUBMISSION_ID
                join ds_cycle dc on dds.CYCLE_ID =dc.ID
                left join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE  and dc.DS_TYPE =dcen.CENTER_TYPE

                where dds.SUBMIT_DT not in (SELECT  MAX(ddsNew.SUBMIT_DT ) SUBMIT_DT
                FROM ds_data_submission ddsNew
                join  ds_top_patient dtpNew on ddsNew.ID =dtpNew.SUBMISSION_ID
                GROUP BY dtpNew.PATIENT_ID_NO ,dtpNew.PATIENT_ID_TYPE )
                ) T1
            where 1 = 1
            <#if patientIdType??> AND  :patientIdType = T1.PATIENT_ID_TYPE</#if>
            <#if patientIdNo??> AND  :patientIdNo = T1.PATIENT_ID_NO</#if>
         ]]>
    </sql>

    <sql key = "searchByVss" remarks="Search Voluntary Sterilisation">
        <![CDATA[
            SELECT distinct dds.ID ,CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME,dds.SUBMISSION_NO ,dvt.PATIENT_NAME ,dvt.PATIENT_ID_TYPE ,dvt.PATIENT_ID_NO ,dvt.PATIENT_BIRTHDAY ,dvt.MARITAL_STATUS ,dvt.STERILIZATION_REASON ,dds.SUBMIT_DT ,1 num
            FROM ds_vs_treatment dvt
            join ds_data_submission dds on dvt.SUBMISSION_ID =dds.ID
            join ds_cycle dc on dds.CYCLE_ID =dc.ID
            left join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE  and dc.DS_TYPE =dcen.CENTER_TYPE
            where 1 = 1
            <#if patientIdType??> AND  charindex(:patientIdType, dvt.PATIENT_ID_TYPE) >0</#if>
            <#if patientIdNo??> AND  charindex(:patientIdNo, dvt.PATIENT_ID_NO) >0</#if>
            <#if submissionNo??> AND  charindex(:submissionNo, dds.SUBMISSION_NO) >0</#if>
            <#if patientName??> AND  charindex(:patientName, dvt.PATIENT_NAME) >0</#if>
            <#if maritalStatus??> AND  charindex(:maritalStatus, dvt.MARITAL_STATUS) >0</#if>
            <#if sterilisationReason??> AND  charindex(:sterilisationReason, dvt.STERILIZATION_REASON) >0</#if>
            <#if submissionDateFrom??> AND T1.SUBMIT_DT >= convert(date,:submissionDateFrom)</#if>
            <#if submissionDateTo??> AND T1.SUBMIT_DT <= convert(datetime,:submissionDateTo)</#if>
         ]]>
    </sql>

    <sql key = "searchVssAjax" remarks="Search Voluntary Sterilisation Ajax">
        <![CDATA[
            SELECT distinct dds.ID ,CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME,dds.SUBMISSION_NO ,dvt.PATIENT_NAME ,dvt.PATIENT_ID_TYPE ,dvt.PATIENT_ID_NO ,dvt.PATIENT_BIRTHDAY ,dvt.MARITAL_STATUS ,dvt.STERILIZATION_REASON ,dds.SUBMIT_DT ,1 num
            FROM ds_vs_treatment dvt
            join ds_data_submission dds on dvt.SUBMISSION_ID =dds.ID
            join ds_cycle dc on dds.CYCLE_ID =dc.ID
            left join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE  and dc.DS_TYPE =dcen.CENTER_TYPE
            where 1 = 1
            <#if patientIdType??> AND  charindex(:patientIdType, dvt.PATIENT_ID_TYPE) >0</#if>
            <#if patientIdNo??> AND  charindex(:patientIdNo, dvt.PATIENT_ID_NO) >0</#if>

         ]]>
    </sql>


    <sql key = "searchByDrpPatient" remarks="Search Drug Practices Patient">
        <![CDATA[

             SELECT distinct dds.ID,
              CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME ,dds.SUBMISSION_NO,dpi.NAME PATIENT_NAME, dpi.ID_TYPE PATIENT_ID_TYPE, dpi.ID_NUMBER PATIENT_ID_NO, dpi.DATE_OF_BIRTH PATIENT_BIRTHDAY, dds.SUBMIT_DT,dc2.PATIENT_CODE CD_PATIENT_CODE,dpi.PATIENT_CODE
                FROM ds_patient_information dpi
                join ds_data_submission dds on (dds.ID = dpi.SUBMISSION_ID or dds.CYCLE_ID in(select dcp.ID from ds_cycle dcp where dcp.PATIENT_CODE = dpi.PATIENT_CODE)) AND dds.STATUS in ('DS001', 'DS011')
                JOIN ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.DS_TYPE = 'DRP'
                join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dc.DS_TYPE =dcen.CENTER_TYPE
                left join ds_cycle dc2 on dc2.PATIENT_CODE = dpi.PATIENT_CODE
                where 1=1
            <#if arCenter??> AND  dc.HCI_CODE = :arCenter </#if>
            <#if patientName??> AND  charindex(:patientName, dpi.NAME) >0</#if>
            <#if patientIdNumber??> AND  :patientIdNumber = dpi.ID_NUMBER </#if>
            <#if patientIdType??> AND  charindex(:patientIdType, T1.PATIENT_ID_TYPE) >0</#if>
            <#if birthDateFrom??> AND dpi.DATE_OF_BIRTH >= convert(date,:birthDateFrom)</#if>
            <#if birthDateTo??> AND dpi.DATE_OF_BIRTH <= convert(datetime,:birthDateTo)</#if>
            <#if submissionDateFrom??> AND dds.SUBMIT_DT >= convert(date,:submissionDateFrom)</#if>
            <#if submissionDateTo??> AND dds.SUBMIT_DT <= convert(datetime,:submissionDateTo)</#if>
            <#if submissionNo??> AND  charindex(:submissionNo, dds.SUBMISSION_NO) >0</#if>
            <#if dc_licenseeId??> AND  :dc_licenseeId = dc.LICENSEE_ID</#if>
         ]]>
    </sql>

    <sql key = "searchByDrpAjax" remarks="Search Drug Practices Ajax">
        <![CDATA[
            SELECT distinct dds.ID,
                CONCAT(case dcen.CENTER_NAME when null then '-, ' else dcen.CENTER_NAME + ', ' end ,
                  case dcen.BLK_NO when null then null else ''+dcen.BLK_NO end ,
               case dcen.STREET_NAME when null then null else ' '+dcen.STREET_NAME end
               , case dcen.BUILDING_NAME when null then null else ' '+dcen.BUILDING_NAME end
               , case dcen.FLOOR_NO when null then null else ' #'+dcen.FLOOR_NO end
               , case dcen.UNIT_NO when null then null else '-'+dcen.UNIT_NO end
               ,case dcen.POSTAL_CODE when null then null else ', '+dcen.POSTAL_CODE end
              ) AS CENTER_NAME,
                dds.SUBMISSION_NO ,ddpd.DRUG_TYPE ,ddpd.MEDICATION ,ddpd.DOCTOR_REIGN_NO ,NULL DOCTOR_NAME ,dds.SUBMIT_DT
              FROM ds_dp_prescribed_dispensed ddpd
            join ds_data_submission dds on dds.ID=ddpd.SUBMISSION_ID
            join ds_cycle dc on dc.ID =dds.CYCLE_ID and dc.CYCLE_TYPE='DSCL_005'
            join ds_center dcen on dcen.HCI_CODE =dc.HCI_CODE and dc.DS_TYPE =dcen.CENTER_TYPE
            where 1 = 1
            <#if patientCode??> AND  :patientCode = dc.PATIENT_CODE</#if>

         ]]>
    </sql>

    <sql key = "ar-quick-view" remarks="search patient by Assisted Reproduction quick view">
        <![CDATA[

            <div class="row">
                <h4>Co - Funding History</h4>
                <div class="quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Total No. of Co-funded  </p>
                        <p class="cycname"> IUI Cycles</p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">IUICyclesNumber</p>
                    </div>
                </div>
                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Total No. of Co-funded  </p>
                        <p class="cycname"> ART Fresh Cycles</p>
                    </div>
                    <div class="col-xs-4 col-md-2 ">
                        <p class="number">ARTFreshCyclesNumber</p>
                    </div>
                </div>
                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Total No. of Co-funded  </p>
                        <p class="cycname"> ART Frozen Cycles</p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">ARTFrozenCyclesNumber</p>
                    </div>
                </div>
                <div class="quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Total Number of co-funded  </p>
                        <p class="cycname"> PGT Cycles</p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">PGTCyclesNumber</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <h4>Total Inventory</h4>
                <div class="quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Fresh Oocytes  </p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">FreshOocytesNumber</p>
                    </div>
                </div>
                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Frozen Oocytes  </p>
                    </div>
                    <div class="col-xs-4 col-md-2 ">
                        <p class="number">FrozenOocytesNumber</p>
                    </div>
                </div>
                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Fresh Embryos  </p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">FreshEmbryosNumber</p>
                    </div>
                </div>

                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Frozen Embryos  </p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">FrozenEmbryosNumber</p>
                    </div>
                </div>
                <div class=" quickview-row">
                    <div class="col-xs-10 col-md-10">
                        <p class="">  Frozen Sperms  </p>
                    </div>
                    <div class="col-xs-2 col-md-2">
                        <p class="number">FrozenSpermsNumber</p>
                    </div>
                </div>

            </div>
            <div class="row">
                <h4><a href="#" onclick="fullDetailsView('patientCode')">View Full Details</a></h4>
            </div>



        ]]>
    </sql>
</sqls>